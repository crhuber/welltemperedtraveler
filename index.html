<html>
<head>
  <title>World Weather</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
    }
    * {
      box-sizing: border-box;
    }
    #header {
      background: #f1f1f1;
      margin-bottom: 10px;
      padding: 5px 20px;
      top: 0;
      width: 100%;
    }
    h1 {
      display: inline-block;
      font-size: 27px;
      font-weight: 100;
      line-height: 32px;
    }
    #search {
      display: inline-block;
      margin: 0 20px;
    }
    #search input {
      font-size: 19px;
      padding: 5px;
    }
    h1, #logo, #search {
      vertical-align: middle;
    }
    /* Pop-up */
    #popup {
      background-color: #fff;
      border: 1px solid #222;
      box-shadow: 15px 15px 23px rgba(0, 0, 0, 0.4);
      padding: 10px;
      position: fixed;
    }
    /* Table */
    #t {
      margin: 20px auto;
      width: 1080px; /* 12 * 80 + 120 */
    }
    /* Header */
    .lh {
      overflow: hidden;
      text-overflow: ellipsis;
      width: 120px;
    }
    .lh span {
      white-space: nowrap;
    }
    /* Line */
    .l {
      border-bottom: 1px solid #555;
      display: inline-block;
      white-space: nowrap;
    }
    /* Cell */
    .c {
      height: 40px;
      padding: 7px;
      text-align: center;
      width: 40px;
    }
    /* Rainfall icon */
    .rf {
      pointer-events: none;
    }
    .p.lh {
      color: #888;
    }
    .c.e {
      border-right: 1px solid #555;
    }
    .c.f {
      border-left: 1px solid #555;
    }
    .ch, .lh, .c {
      display: inline-block;
    }
    .lh, .c {
      vertical-align: middle;
    }
    .ch {
      font-weight: bold;
      padding: 7px 0;
      text-align: center;
      width: 80px;
    }
    #legend {
      display: inline-block;
      position: absolute;
      right: 17px;
      top: 22px;
    }
    #legend img {
      height: 50px;
      vertical-align: middle;
    }
    #scale {
      display: inline-block;
    }
    #footer {
      font-size: 12px;
      margin: 25px 0;
      text-align: center;
    }
  </style>
  <script>
  COLORS = [
    [-15, [0, 57, 191]],   // Inhumanely cold, very dark blue
    [-8, [0, 78, 234]],    // Freezing, dark blue
    [3, [0, 167, 239]],    // Cold, blue
    [12, [5, 255, 217]],   // Chilly, turquoise
    [22, [3, 186, 0]],     // Comfy, green
    [26, [255, 255, 0]],   // Warm, yellow
    [28, [255, 140, 0]],   // A bit too warm, orange
    [33, [255, 0, 34]],    // Very hot, red
    [40, [175, 0, 0]],    // Hellish, dark red
  ]
    var cities = [];
    var filteredCities = [];
    var data;
    var localMonthNames = [];
    for (var i = 1; i < 13; i++) {
      localMonthNames.push(
        new Date('2000.' + i + '.01').toLocaleString(
          window.navigator.language, { month: "short" }
      ));
    }

    function loadData() {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
          data = JSON.parse(xhr.responseText);
          processData(data);
        }
      }
      xhr.open('GET', 'data.txt', true);
      xhr.send(null);
    }

    function processData(data) {
      // More than 3 half-months with non-zero temp and we assume we have data.
      var threshold = 3;
      for (city in data) {
        var halfMonthsWithData = 0;
        for (var halfMonth in data[city]) {
          if (data[city][halfMonth][1] != 0) {
            halfMonthsWithData++;
            if (halfMonthsWithData >= threshold) {
              cities.push(city);
              break;
            }
          }
        }
      }
      cities.sort();
      filteredCities = cities;
      showLegend();
      drawData();
      setupListeners();
    }

    function drawData() {
      document.getElementById('t').innerHTML = '';
      for (var i = 0, city; city = filteredCities[i]; i++) {
        if (i % 10 == 0) {
          showColumnHeaders();
        }
        showSingleCity(city);
      }
    }

    function setupListeners() {
      document.getElementById('t').addEventListener('mouseover', function(e) {
        var cell = document.elementFromPoint(e.clientX, e.clientY);
        var popup = document.getElementById('popup');
        if (!cell.hasAttribute('tmp-avg')) {
          popup.style.display = 'none';
          return;
        }
        var tmpMin = cell.getAttribute('tmp-min');
        var tmpAvg = cell.getAttribute('tmp-avg');
        var tmpMax = cell.getAttribute('tmp-max');
        var rainfall = cell.getAttribute('rain');
        popup.innerHTML = 'Min: ' + tmpMin + '°C<br>Mean: ' +
            tmpAvg + '°C<br>Max: ' + tmpMax + '°C<br>Avg rainfall: ' +
            rainfall + '0mm';
        popup.style.display = 'inline-block';
        popup.style.left = e.clientX + 20;
        popup.style.top = e.clientY + 20;
        return true;
      });
      document.getElementById('t').addEventListener('mouseout', function() {
        document.getElementById('popup').style.display = 'none';
      });
      document.getElementById('popup').style.display = 'none';
      document.getElementById('sb').addEventListener('input', function(e) {
        var input = e.target.value;
        filteredCities = [];
        for (var i = 0, city; city = cities[i]; i++) {
          if (city.toLowerCase().indexOf(input.toLowerCase()) != -1) {
            filteredCities.push(city);
          }
        }
        drawData();
      });
      document.getElementById('sb').focus();
    }

    function showLegend() {
      var scale = document.getElementById('scale');
      for (var i = 0; i < COLORS.length; i++) {
        var cell = document.createElement('div');
        cell.classList.add('c');
        cell.style.backgroundColor = getCellColor(COLORS[i][0]);
        scale.appendChild(cell);
      }
    }

    function showColumnHeaders() {
      var table = document.getElementById('t');
      var colHeaders = document.createElement('div');
      colHeaders.classList.add('l');
      var pivot = document.createElement('div');
      pivot.classList.add('lh');
      pivot.classList.add('p');
      colHeaders.appendChild(pivot);
      for (var i = 0; i < 12; i++) {
        var colHeader = document.createElement('div');
        colHeader.textContent = localMonthNames[i];
        colHeader.classList.add('ch');
        colHeaders.appendChild(colHeader);
      }
      table.appendChild(colHeaders);
    }

    function showSingleCell(city, halfMonth, oddNumberCell, firstCell,
          container) {
      var tmps = data[city][halfMonth];
      var minTmp = tmps[0];
      var average_temperature = tmps[1];
      var maxTmp = tmps[2];
      var rainfall = tmps[3];
      var cell = document.createElement('div');
      cell.classList.add('c');
      cell.classList.add(oddNumberCell ? 's' : 'e');
      cell.setAttribute('tmp-min', '' + minTmp);
      cell.setAttribute('tmp-avg', '' + average_temperature);
      cell.setAttribute('tmp-max', '' + maxTmp);
      cell.setAttribute('rain', '' + rainfall);
      if (firstCell) {
        cell.classList.add('f');
      }
      cell.style.backgroundColor = getCellColor(parseInt(average_temperature));
      var rainImage = document.createElement('img');
      rainImage.classList.add('rf');
      rainImage.src = 'droplet.png';
      rainImage.style.opacity = Math.min(1.0, parseInt(rainfall) / 14.0);
      cell.appendChild(rainImage);
      container.appendChild(cell);
    }

    function showSingleCity(city) {
      var line = document.createElement('div');
      var cityNameHeader = document.createElement('div');
      var cityNameSpan = document.createElement('span');
      line.className = 'l';
      cityNameSpan.textContent = city;
      cityNameHeader.className = 'lh';
      cityNameHeader.appendChild(cityNameSpan);
      line.appendChild(cityNameHeader);
      var i = 0;
      for (var month = 1; month < 13; month++) {
        for (var suffix = 1; suffix < 3; suffix++) {
          showSingleCell(
            city, '' + month + '-' + suffix, i % 2 == 0, i == 0, line);
          i++;
        }
      }
      for (halfMonth in data[city]) {
      }
      document.getElementById('t').appendChild(line);
    }

    function cssColorFromTuple(tuple) {
      return 'rgb(' + tuple[0] + ', ' + tuple[1] + ',' + tuple[2] + ')';
    }

    function getCellColor(tmp_avg) {
      if (tmp_avg <= COLORS[0][0]) {
        return cssColorFromTuple(COLORS[0][1]);
      }
      if (tmp_avg >= COLORS[COLORS.length - 1][0]) {
        return cssColorFromTuple(COLORS[COLORS.length - 1][1]);
      }
      var lowIndex = 0;
      for (var i = 0, color; color = COLORS[i]; i++) {
        if (tmp_avg >= color[0] && tmp_avg < COLORS[i + 1][0]) {
          lowIndex = i;
          break;
        }
      }
      var fraction = (tmp_avg - COLORS[lowIndex][0]) /
          (COLORS[lowIndex + 1][0] - COLORS[lowIndex][0]);
      var targetColor = [];
      for (var i = 0; i < 3; i++) {
        var lowValue  = COLORS[lowIndex][1][i];
        var highValue = COLORS[lowIndex + 1][1][i];
        targetColor.push(Math.floor(lowValue + fraction * (highValue - lowValue)));
      }
      return cssColorFromTuple(targetColor);
    }

  </script>
</head>

<body onload="loadData();">
  <div id="header">
  <h1><a href="https://google.com"><img id="logo" src="google.png" /></a>&nbsp;&nbsp;World Weather</h1>

  <div id="search"><input id="sb"></input></div>

  <div id="legend">
    <img src="cold.png" alt="Cold">
    <div id="scale"></div>
    <img src="hot.png" alt="Hot">
  </div>
</div>
<div id="t"></div>
<div id="popup"></div>

<div id="footer">
  Made from weather data collected over the past 10
  years&nbsp;–&nbsp;<a href="https://www.google.com/intl/en/policies/">Privacy &amp; Terms
</div>

</body>
</html>
