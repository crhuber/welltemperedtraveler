<html>
<head>
  <title>World Weather</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    * {
      box-sizing: border-box;
    }
    /* Table */
    .t {
      margin: 0 auto;
      width: 850px;
    }
    /* Header */
    .lh {
      overflow: hidden;
      width: 100px;
    }
    /* Line */
    .l {
      border-bottom: 1px solid #ccc;
    }
    /* Cell */
    .c {
      height: 35px;
      padding: 3px;
      width: 35px;
    }
    .c.e {
      border-right: 1px solid #ccc;
    }
    .ch, .lh, .c {
      display: inline-block;
    }
    .lh, .c {
      vertical-align: middle;
    }
    .ch {
      border-bottom: 1px solid #ccc;
      font-weight: bold;
      padding: 7px 0;
      text-align: center;
      width: 70px;
    }
  </style>
  <script>
    var cities = [];
    var data;
    var localMonthNames = [];
    for (var i = 1; i < 13; i++) {
      localMonthNames.push(
        new Date('2000.' + i + '.01').toLocaleString(
          window.navigator.language, { month: "short" }
      ));
    }

    function loadData() {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
          data = JSON.parse(xhr.responseText);
          processData(data);
        }
      }
      xhr.open('GET', 'data.txt', true);
      xhr.send(null);
    }

    function processData(data) {
      showColumnHeaders();
      for (city in data) {
        var cityHasData = false;
        for (var halfMonth in data[city]) {
          if (data[city][halfMonth][0] != 0) {
            cityHasData = true;
            break;
          }
        }
        if (cityHasData) {
          cities.push(city);
        }
      }
      cities.sort();
      for (var i = 0, city; city = cities[i]; i++) {
        showSingleCity(city);
      }
    }

    function showColumnHeaders() {
      var table = document.getElementById('t');
      var colHeaders = document.createElement('div');
      var pivot = document.createElement('div');
      pivot.className = 'lh';
      colHeaders.appendChild(pivot);
      for (var i = 0; i < 12; i++) {
        var colHeader = document.createElement('div');
        colHeader.textContent = localMonthNames[i];
        colHeader.className = 'ch';
        colHeaders.appendChild(colHeader);
      }
      table.appendChild(colHeaders);
    }

    function showSingleCell(city, halfMonth, oddNumberCell, container) {
      var average_temperature = data[city][halfMonth];
      var cell = document.createElement('div');
      cell.textContent = average_temperature;
      cell.className = 'c ' + (oddNumberCell ? 's' : 'e');
      cell.style.backgroundColor = getCellColor(parseInt(average_temperature));
      container.appendChild(cell);
    }

    function showSingleCity(city) {
      var line = document.createElement('div');
      var cityName = document.createElement('div');
      line.className = 'l';
      cityName.textContent = city;
      cityName.className = 'lh';
      line.appendChild(cityName);
      var i = 0;
      for (var month = 1; month < 13; month++) {
        for (var suffix = 1; suffix < 3; suffix++) {
          showSingleCell(city, '' + month + '-' + suffix, i % 2 == 0, line);
          i++;
        }
      }
      for (halfMonth in data[city]) {
      }
      document.getElementById('t').appendChild(line);
    }

    // Inhumanely cold 157, 0, 255 -- purple
    // Freezing 0, 78, 234 -- darker blue
    // Cold 0, 167, 239 -- blue
    // Chilly 5, 255, 217 -- turquoise
    // Comfy 3, 186, 0 -- green
    // Warm 255, 255, 0 -- yellow
    // A bit too warm 255, 140, 0 -- orange
    // Very hot 255, 0, 34 -- red
    // Hellish 219, 29, 0  -- dark red

    COLORS = [
      [-12, [157, 0, 255]],  // Inhumanely Cold
      [-5, [0, 78, 234]],    // Freezing
      [5, [0, 167, 239]],    // Cold
      [12, [5, 255, 217]],   // Chilly
      [22, [3, 186, 0]],     // Comfy
      [26, [255, 255, 0]],   // Warm
      [28, [255, 140, 0]],   // A bit too warm
      [32, [255, 0, 34]],    // Very hot
      [37, [219, 29, 0]],    // Hellish
    ]

    function cssColorFromTuple(tuple) {
      return 'rgb(' + tuple[0] + ', ' + tuple[1] + ',' + tuple[2] + ')';
    }

    function getCellColor(tmp_avg) {
      if (tmp_avg <= COLORS[0][0]) {
        return cssColorFromTuple(COLORS[0][1]);
      }
      if (tmp_avg >= COLORS[COLORS.length - 1][0]) {
        return cssColorFromTuple(COLORS[COLORS.length - 1][1]);
      }
      var lowIndex = 0;
      for (var i = 0, color; color = COLORS[i]; i++) {
        if (tmp_avg >= color[0] && tmp_avg < COLORS[i + 1][0]) {
          lowIndex = i;
          break;
        }
      }
      var fraction = (tmp_avg - COLORS[lowIndex][0]) /
          (COLORS[lowIndex + 1][0] - COLORS[lowIndex][0]);
      var targetColor = [];
      for (var i = 0; i < 3; i++) {
        var lowValue  = COLORS[lowIndex][1][i];
        var highValue = COLORS[lowIndex + 1][1][i];
        targetColor.push(Math.floor(lowValue + fraction * (highValue - lowValue)));
      }
      return cssColorFromTuple(targetColor);
    }

  </script>
</head>

<body onload="loadData();">
<h1>World Weather</h1>

<div id="t"></div>

</body>
</html>
